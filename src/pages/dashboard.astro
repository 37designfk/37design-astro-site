---
// Marketing OS Dashboard - Internal monitoring tool
// Standalone page (no Layout.astro wrapper)
---

<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="theme-color" content="#0a0f1e" />
    <title>Marketing OS Dashboard | 37Design</title>
    <link rel="icon" href="/favicon.png" type="image/png" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;600;700;900&display=swap"
      rel="stylesheet"
    />
    <script is:inline src="https://cdn.tailwindcss.com"></script>
    <script is:inline>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Noto Sans JP"', 'sans-serif'],
            },
            colors: {
              surface: '#0a0f1e',
              accent: '#f5d020',
            },
          },
        },
      };
    </script>
    <style is:inline>
      body { background: #0a0f1e; font-family: 'Noto Sans JP', sans-serif; }
      .card {
        background: rgba(255,255,255,0.05);
        backdrop-filter: blur(12px);
        border: 1px solid rgba(255,255,255,0.1);
        border-radius: 1rem;
      }
      .card:hover { border-color: rgba(245,208,32,0.2); }
      @keyframes shimmer {
        0% { background-position: -200% 0; }
        100% { background-position: 200% 0; }
      }
      .skeleton {
        background: linear-gradient(90deg,rgba(255,255,255,0.04) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.04) 75%);
        background-size: 200% 100%;
        animation: shimmer 1.5s ease-in-out infinite;
        border-radius: 0.5rem;
      }
      .fade-in { animation: fadeIn 0.4s ease-out; }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(6px); }
        to { opacity: 1; transform: translateY(0); }
      }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
      ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.25); }
    </style>
  </head>
  <body class="text-gray-200 min-h-screen antialiased">

    <!-- Header -->
    <header class="sticky top-0 z-50 border-b border-white/10" style="background:rgba(10,15,30,0.9);backdrop-filter:blur(16px)">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
          <div>
            <h1 class="text-xl sm:text-2xl font-bold text-white flex items-center gap-2">
              <span style="color:#f5d020">&#9670;</span>
              Marketing OS ダッシュボード
            </h1>
            <p class="text-sm text-gray-400 mt-0.5">37Design 自動運用システム</p>
          </div>
          <div class="flex items-center gap-4">
            <span id="last-updated" class="text-xs text-gray-500">読み込み中...</span>
            <button
              id="refresh-btn"
              onclick="fetchData()"
              class="px-3 py-1.5 text-sm rounded-lg border border-white/10 text-gray-300 hover:border-accent hover:text-accent transition-colors"
            >↻ 更新</button>
          </div>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">

      <!-- KPI Cards -->
      <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div class="card p-4">
          <p class="text-xs text-gray-400 mb-1">記事数</p>
          <p id="kpi-articles" class="text-2xl font-bold text-white skeleton h-8">-</p>
        </div>
        <div class="card p-4">
          <p class="text-xs text-gray-400 mb-1">セッション (今日)</p>
          <p id="kpi-sessions" class="text-2xl font-bold text-white skeleton h-8">-</p>
        </div>
        <div class="card p-4">
          <p class="text-xs text-gray-400 mb-1">クリック (GSC)</p>
          <p id="kpi-clicks" class="text-2xl font-bold text-white skeleton h-8">-</p>
        </div>
        <div class="card p-4">
          <p class="text-xs text-gray-400 mb-1">平均順位 (GSC)</p>
          <p id="kpi-position" class="text-2xl font-bold text-white skeleton h-8">-</p>
        </div>
      </div>

      <!-- WFステータス + タスクキュー -->
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- WF実行状況 -->
        <div class="card p-5">
          <h2 class="text-base font-semibold text-white mb-4 flex items-center gap-2">
            <span style="color:#f5d020">&#9656;</span> WF実行状況
          </h2>
          <div id="wf-list" class="space-y-2">
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
          </div>
        </div>

        <!-- タスクキュー -->
        <div class="card p-5">
          <h2 class="text-base font-semibold text-white mb-4 flex items-center gap-2">
            <span style="color:#f5d020">&#9656;</span> タスクキュー (直近10件)
          </h2>
          <div id="task-list" class="space-y-2">
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
            <div class="skeleton h-10 w-full"></div>
          </div>
        </div>

      </div>

      <!-- GA4 / GSC -->
      <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">

        <!-- GA4 -->
        <div class="card p-5">
          <h2 class="text-base font-semibold text-white mb-4 flex items-center gap-2">
            <span style="color:#f5d020">&#9656;</span> GA4 (直近7日)
          </h2>
          <div id="ga4-table" class="overflow-x-auto">
            <div class="skeleton h-40 w-full"></div>
          </div>
        </div>

        <!-- GSC -->
        <div class="card p-5">
          <h2 class="text-base font-semibold text-white mb-4 flex items-center gap-2">
            <span style="color:#f5d020">&#9656;</span> GSC (直近7日)
          </h2>
          <div id="gsc-table" class="overflow-x-auto">
            <div class="skeleton h-40 w-full"></div>
          </div>
        </div>

      </div>

      <!-- GSC トップページ -->
      <div class="card p-5">
        <h2 class="text-base font-semibold text-white mb-4 flex items-center gap-2">
          <span style="color:#f5d020">&#9656;</span> GSC トップページ
        </h2>
        <div id="gsc-top-pages" class="overflow-x-auto">
          <div class="skeleton h-32 w-full"></div>
        </div>
      </div>

    </main>

    <script is:inline>
      const API_URL = 'https://n8n-37design.37d.jp/webhook/Hjb8yPWw97g6m0C5/webhooktrigger/wf7-dashboard-api';

      // ステータスバッジ
      function statusBadge(status) {
        const map = {
          success:   ['bg-green-500/20 text-green-400 border border-green-500/30', '✓ success'],
          error:     ['bg-red-500/20 text-red-400 border border-red-500/30', '✗ error'],
          running:   ['bg-blue-500/20 text-blue-400 border border-blue-500/30 animate-pulse', '⟳ running'],
          pending:   ['bg-yellow-500/20 text-yellow-400 border border-yellow-500/30', '◌ pending'],
          completed: ['bg-green-500/20 text-green-400 border border-green-500/30', '✓ completed'],
          warning:   ['bg-orange-500/20 text-orange-400 border border-orange-500/30', '⚠ warning'],
        };
        const [cls, label] = map[status] || ['bg-gray-500/20 text-gray-400 border border-gray-500/30', status];
        return `<span class="px-2 py-0.5 rounded text-xs font-medium ${cls}">${label}</span>`;
      }

      // 経過時間
      function timeAgo(dtStr) {
        if (!dtStr) return '-';
        try {
          const dt = new Date(dtStr.replace(' ', 'T'));
          const diff = Math.floor((Date.now() - dt) / 1000);
          if (diff < 60) return `${diff}秒前`;
          if (diff < 3600) return `${Math.floor(diff/60)}分前`;
          if (diff < 86400) return `${Math.floor(diff/3600)}時間前`;
          return `${Math.floor(diff/86400)}日前`;
        } catch(e) { return dtStr; }
      }

      // 実行秒数
      function execSec(start, stop) {
        if (!start || !stop) return '';
        try {
          const s = new Date(start.replace(' ', 'T'));
          const e = new Date(stop.replace(' ', 'T'));
          const sec = Math.round((e - s) / 1000);
          return ` (${sec}s)`;
        } catch(e) { return ''; }
      }

      // テーブル生成ヘルパー
      function buildTable(headers, rows) {
        if (!rows || rows.length === 0) {
          return '<p class="text-sm text-gray-500 italic py-4 text-center">データなし</p>';
        }
        const thead = `<tr>${headers.map(h => `<th class="text-left text-xs text-gray-400 font-medium py-2 px-2 whitespace-nowrap">${h}</th>`).join('')}</tr>`;
        const tbody = rows.map((row, i) =>
          `<tr class="${i % 2 === 0 ? '' : 'bg-white/[0.02]'}">${row.map(cell => `<td class="py-1.5 px-2 text-sm text-gray-300 whitespace-nowrap">${cell}</td>`).join('')}</tr>`
        ).join('');
        return `<table class="w-full min-w-full"><thead>${thead}</thead><tbody>${tbody}</tbody></table>`;
      }

      async function fetchData() {
        const btn = document.getElementById('refresh-btn');
        btn.textContent = '読込中...';
        btn.disabled = true;

        try {
          const res = await fetch(API_URL, { cache: 'no-store' });
          if (!res.ok) throw new Error(`HTTP ${res.status}`);
          const data = await res.json();
          renderData(data);
          document.getElementById('last-updated').textContent =
            '最終更新: ' + new Date().toLocaleTimeString('ja-JP');
        } catch(e) {
          console.error('Fetch error:', e);
          document.getElementById('last-updated').textContent = 'エラー: ' + e.message;
        } finally {
          btn.textContent = '↻ 更新';
          btn.disabled = false;
        }
      }

      function renderData(data) {
        // KPIs
        const ga4 = data.ga4 || [];
        const gsc = data.gsc || [];
        const latestGa4 = ga4[0] || {};
        const latestGsc = gsc[0] || {};

        function setKpi(id, val) {
          const el = document.getElementById(id);
          el.textContent = val;
          el.classList.remove('skeleton');
          el.classList.add('fade-in');
        }
        setKpi('kpi-articles', data.article_count ?? '-');
        setKpi('kpi-sessions', latestGa4.sessions != null ? latestGa4.sessions.toLocaleString() : '-');
        setKpi('kpi-clicks', latestGsc.clicks != null ? latestGsc.clicks.toLocaleString() : '-');
        setKpi('kpi-position', latestGsc.avg_position != null ? latestGsc.avg_position.toFixed(1) : '-');

        // WF実行状況
        const wfList = document.getElementById('wf-list');
        const wfs = data.wf_status || [];
        if (wfs.length === 0) {
          wfList.innerHTML = '<p class="text-sm text-gray-500 italic">データなし</p>';
        } else {
          wfList.innerHTML = wfs.map(wf =>
            `<div class="flex items-center justify-between py-2 px-3 rounded-lg bg-white/[0.03] fade-in">
              <div class="flex items-center gap-3 min-w-0">
                ${statusBadge(wf.status)}
                <span class="text-sm text-gray-200 font-medium truncate">${wf.name}</span>
              </div>
              <span class="text-xs text-gray-500 shrink-0 ml-2">
                ${timeAgo(wf.stoppedAt)}${execSec(wf.startedAt, wf.stoppedAt)}
              </span>
            </div>`
          ).join('');
        }

        // タスクキュー
        const taskList = document.getElementById('task-list');
        const tasks = data.tasks || [];
        if (tasks.length === 0) {
          taskList.innerHTML = '<p class="text-sm text-gray-500 italic">タスクなし</p>';
        } else {
          taskList.innerHTML = tasks.map(t =>
            `<div class="flex items-center justify-between py-2 px-3 rounded-lg bg-white/[0.03] fade-in">
              <div class="flex items-center gap-2 min-w-0">
                ${statusBadge(t.status)}
                <span class="text-xs px-1.5 py-0.5 rounded bg-white/5 text-gray-400">${t.action === 'rewrite' ? '✎ rewrite' : '+ new'}</span>
                <span class="text-sm text-gray-200 truncate" title="${t.keyword}">${t.slug}</span>
              </div>
              <span class="text-xs text-gray-500 shrink-0 ml-2">${t.date}</span>
            </div>`
          ).join('');
        }

        // GA4テーブル
        document.getElementById('ga4-table').innerHTML = buildTable(
          ['日付', 'セッション', 'PV'],
          ga4.map(row => [row.date, row.sessions?.toLocaleString() ?? '-', row.page_views?.toLocaleString() ?? '-'])
        );

        // GSCテーブル
        document.getElementById('gsc-table').innerHTML = buildTable(
          ['日付', 'クリック', '表示', 'CTR', '平均順位'],
          gsc.map(row => [
            row.date,
            row.clicks ?? '-',
            row.impressions?.toLocaleString() ?? '-',
            row.ctr != null ? (row.ctr * 100).toFixed(1) + '%' : '-',
            row.avg_position?.toFixed(1) ?? '-'
          ])
        );

        // GSCトップページ
        const topPages = data.gsc_top_pages || [];
        document.getElementById('gsc-top-pages').innerHTML = buildTable(
          ['ページ', 'クリック', '表示', 'CTR', '平均順位'],
          topPages.map(p => [
            `<span class="text-xs text-gray-400">${p.page}</span>`,
            p.clicks ?? '-',
            p.impressions?.toLocaleString() ?? '-',
            p.ctr != null ? (p.ctr * 100).toFixed(1) + '%' : '-',
            p.position?.toFixed(1) ?? '-'
          ])
        );
      }

      // 初回ロード
      fetchData();

      // 60秒ごとに自動更新
      setInterval(fetchData, 60000);
    </script>

  </body>
</html>
