---
const stats = [
  { number: 50, prefix: "", suffix: "+社", label: "導入企業数", icon: "M18 18.72a9.094 9.094 0 0 0 3.741-.479 3 3 0 0 0-4.682-2.72m.94 3.198.001.031c0 .225-.012.447-.037.666A11.944 11.944 0 0 1 12 21c-2.17 0-4.207-.576-5.963-1.584A6.062 6.062 0 0 1 6 18.719m12 0a5.971 5.971 0 0 0-.941-3.197m0 0A5.995 5.995 0 0 0 12 12.75a5.995 5.995 0 0 0-5.058 2.772m0 0a3 3 0 0 0-4.681 2.72 8.986 8.986 0 0 0 3.74.477m.94-3.197a5.971 5.971 0 0 0-.94 3.197M15 6.75a3 3 0 1 1-6 0 3 3 0 0 1 6 0Zm6 3a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Zm-13.5 0a2.25 2.25 0 1 1-4.5 0 2.25 2.25 0 0 1 4.5 0Z" },
  { number: 40, prefix: "", suffix: "%", label: "業務時間削減", icon: "M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 0 1 3 19.875v-6.75ZM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V8.625ZM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 0 1-1.125-1.125V4.125Z" },
  { number: 98, prefix: "", suffix: "%", label: "顧客満足度", icon: "M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" },
  { number: 1, prefix: "最短", suffix: "週間", label: "導入期間", icon: "M3.75 13.5l10.5-11.25L12 10.5h8.25L9.75 21.75 12 13.5H3.75z" },
];
---

<section id="numbers" class="relative -mt-16 z-30 pb-8">
  <div class="max-w-5xl mx-auto px-4 md:px-6 lg:px-8">
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
      {stats.map((stat, i) => (
        <div
          class="animate-on-scroll card-hover bg-white rounded-2xl p-5 md:p-7 text-center shadow-[0_4px_24px_rgba(0,0,0,0.08)] border border-border"
          data-anim="scale"
          style={`animation-delay: ${i * 0.1}s`}
        >
          <div class="w-10 h-10 rounded-full bg-primary-950/5 flex items-center justify-center mx-auto mb-3">
            <svg class="w-5 h-5 text-primary-700" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" d={stat.icon} />
            </svg>
          </div>
          <p class="text-3xl md:text-4xl font-black text-primary-950 leading-none">
            <span class="text-base font-bold text-primary-700">{stat.prefix}</span>
            <span class="counter" data-target={stat.number} data-delay={i * 100 + 800}>0</span>
            <span class="text-lg md:text-xl text-accent-500 font-bold">{stat.suffix}</span>
          </p>
          <p class="text-xs md:text-sm text-text-secondary font-medium mt-2">{stat.label}</p>
        </div>
      ))}
    </div>
  </div>
</section>

<script>
  // Counter fires AFTER the fade-in animation completes
  const section = document.getElementById("numbers");
  if (section) {
    let fired = false;
    const sectionObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting && !fired) {
            fired = true;
            sectionObserver.disconnect();

            document.querySelectorAll(".counter").forEach((el) => {
              const target = parseInt((el as HTMLElement).dataset.target || "0", 10);
              const delay = parseInt((el as HTMLElement).dataset.delay || "800", 10);

              // Wait for fade-in animation to finish before counting
              setTimeout(() => {
                const duration = 1800;
                const start = performance.now();

                const animate = (now: number) => {
                  const elapsed = now - start;
                  const progress = Math.min(elapsed / duration, 1);
                  // ease-out cubic
                  const eased = 1 - Math.pow(1 - progress, 3);
                  el.textContent = Math.floor(eased * target).toString();
                  if (progress < 1) {
                    requestAnimationFrame(animate);
                  } else {
                    el.textContent = target.toString();
                  }
                };

                requestAnimationFrame(animate);
              }, delay);
            });
          }
        });
      },
      { threshold: 0.2 }
    );
    sectionObserver.observe(section);
  }
</script>
